---
title: "Stout_DA_case_study"
author: "Yunting Chiu"
date: "10/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Install the packages
```{r, warning=FALSE}
library(tidyverse) # tidy data
library(corrplot) # visualize correlation
library(tidymodels) # data modeling
library(leaps) # model selections
```

# Case Study 1
## Read the data
See the first six observations of the data set.
```{r, warning=FALSE}
loans <- read_csv("./data/loans_full_schema.csv")
head(loans)
```
Below is a data set that represents thousands of loans made through the Lending Club platform, which is a platform that allows individuals to lend to other individuals.\
We would like you to perform the following using the language of your choice:
- Describe the dataset and any issues with it.

## Exploratory Data Analysis

We are right, the data frame has 10,000 observationscand 55 variables.
```{r}
dim(loans)
```


We can see there are some variables have NAs:
- `emp_title`: 833 
- `emp_title`: 817 NAs
- `debt_to_income`: 24 NAs
- `annual_income_joint`: 8505 NAs
- `verification_income_joint`: 8545 NAs
- `debt_to_income_joint`: 8505 NAs
- `months_since_last_delinq`: 5658 NAs
- `months_since_90d_late`: 7715 NAs
- `months_since_last_credit_inquiry`: 1271 NAs
- `num_accounts_120d_past_due`: 318 NAs

Before we build the model, we must take care of the variables with a high number of NAs.
```{r}
loans %>%
summarise_all(funs(sum(is.na(.)))) 
```

Before we start to analyze data, we can see that the vast majority of data type is numerical and categorical.
```{r}
str(loans)
```


```{r}
summary(loans)
```

## Data Visualization
Generate a minimum of 5 unique visualizations using the data and write a brief description of your observations. Additionally, all attempts should be made to make the visualizations visually appealing.

### Plot 1
```{r}
loans 
  
```

# Case Study 2

## Read the Data
There is 1 dataset(csv) with 3 years’ worth of customer orders. There are 4 columns in the csv dataset: index, CUSTOMER_EMAIL (unique identifier as hash), Net Revenue, and Year.
```{r}
cust_orders <- read_csv("./data/customer_orders.csv")
head(cust_orders)
```
There is no NA in the dataset.
```{r}
cust_orders %>%
summarise_all(funs(sum(is.na(.)))) 
```

## Tidy Data

- Total revenue for the current year (2015, 2016 and 2017)
```{r}
cust_orders %>%
  group_by(year) %>%
  summarise(total_revenue = sum(net_revenue))
```

- New Customer Revenue e.g., **new customers not present in previous year only**

note: new customer data for 2015 is not available.
  + Total new customer revenue in 2016: 17,206,367 dollars.
  + Total new customer revenue in 2017: 16,146,519 dollars.
```{r}
cust_orders %>%
 filter(year == 2015) -> orders_2015
#orders_2015 %>%
  #distinct(customer_email)

cust_orders %>%
 filter(year == 2016) -> orders_2016
#orders_2016 %>%
  #distinct(customer_email)

cust_orders %>%
 filter(year == 2017) -> orders_2017
#orders_2017 %>%
 #distinct(customer_email)

# New customer in 2016
orders_2016 %>%
  anti_join(orders_2015, by = "customer_email") -> tmp1
sum(tmp1$net_revenue)

# New customer in 2017
# New customer in 2017 is defined as the new customers not present in the year of 2016, according to the instruction. 2015 is not included in deciding the new customers for 2017.
orders_2016 %>%
  anti_join(orders_2017, by = "customer_email") -> tmp2
sum(tmp2$net_revenue)
```

- Existing Customer Growth. To calculate this, use the Revenue of existing customers for current year –(minus) Revenue of existing customers from the previous year

The existing customer is defined as the customers present in both years (2015 and 2016; 2016 and 2017) so I used inner join to find existing customers for the consecutive two years.

The revenue from existing customers increased by 39043.65 from 2015 to 2016.
```{r}
orders_2015 %>%
  inner_join(orders_2016, by = "customer_email") %>%
  mutate(customer_growth_15_to_16 = net_revenue.y - net_revenue.x) %>%
  select(customer_email, customer_growth_15_to_16) -> growth2016
sum(growth2016$customer_growth_15_to_16)
```

The revenue from existing customers increased by 63857.06 from 2016 to 2017.
```{r}
orders_2016 %>%
  inner_join(orders_2017, by = "customer_email") %>%
  mutate(customer_growth_16_to_17 = net_revenue.y - net_revenue.x) %>%
  select(customer_email, customer_growth_16_to_17) -> growth2017
sum(growth2017$customer_growth_16_to_17)
```

- Revenue lost from attrition
Following the similar logic in question 2, I define attrition as the customers present in the previous year but not in the current year. For example, attrition for the year of 2016 would be the customers present in the year of 2015 but not in 2016.

note: there is no attrition for 2015.

In 2016, the company lost 20,551,216 in total revenue from attrition.
```{r}
# return all rows from 2015 without a match in 2016 based on customer_email
orders_2015 %>%
  anti_join(orders_2016, by = "customer_email") -> attrition2016
sum(attrition2016$net_revenue)
```

In 2017, the company lost 16,146,519 in total revenue from attrition.
```{r}
# return all rows from 2016 without a match in 2017 based on customer_email
orders_2016 %>%
  anti_join(orders_2017, by = "customer_email") -> attrition2017
sum(attrition2017$net_revenue)
```

- Existing Customer Revenue Current Year
Following the same definition, existing customer is defined as the customers present in both years (2015 and 2016; 2016 and 2017).

So the total revenue of the existing customers in 2016 (current year compared to 2015) is 8,524,577 dollars.
```{r}
# return all rows from 2016 with a match in 2015
orders_2016 %>%
  semi_join(orders_2015, by = "customer_email") -> current2016
sum(current2016$net_revenue)
```

The total revenue of the existing customers in 2017 (current year compared to 2016) is 9,648,282 dollars.
```{r}
# return all rows from 2017 with a match in 2016
orders_2017 %>%
  semi_join(orders_2016, by = "customer_email") -> current2017
sum(current2017$net_revenue)
```

- Existing Customer Revenue Prior Year

Similarly total revenue of the existing customers in prior year of 2016 (2015 data) is 8,485,533 dollars.
```{r}
orders_2016 %>%
  inner_join(orders_2015, by = "customer_email") -> prior2016
sum(prior2016$net_revenue.y)
```

The total revenue of the existing customers in prior year of 2017 (2016 data) is 9,584,425 dollars.
```{r}
orders_2017 %>%
  inner_join(orders_2016, by = "customer_email") -> prior2017
sum(prior2017$net_revenue.y)
```

- Total Customers Current Year
- Total Customers Previous Year

Total customer is defined as the total number of unique emails for each year. There are 231,294 customers in 2015, 204,646 in 2016, and 249,987 in 2017.
```{r}
orders_2015 %>%
  distinct(customer_email) %>%
  nrow()

orders_2016 %>%
  distinct(customer_email) %>%
  nrow()

orders_2017 %>%
  distinct(customer_email) %>%
  nrow()  
```

- New Customers

We assume that the new customers were not on the previous year's list. There are 136891 new customers in 2016.
```{r}
orders_2016 %>%
  anti_join(orders_2015, by = "customer_email") %>%
  distinct(customer_email) -> new2016
  nrow(new2016)
```

In 2017, there are 173449 new customers.
```{r}
orders_2017 %>%
  anti_join(orders_2016, by = "customer_email") %>%
  distinct(customer_email) -> new2017
  nrow(new2017)
```

- Lost Customers
Lost customer is also defined as attrition. There are 163,539 lost customers in 2016.

```{r}
orders_2015 %>%
  anti_join(orders_2016, by = "customer_email") %>%
  distinct(customer_email) %>%
  nrow()
```

In 2017, there are 128,108 lost customers.
```{r}
orders_2016 %>%
  anti_join(orders_2017, by = "customer_email") %>%
  distinct(customer_email) %>%
  nrow()
```

## Data Visualization
Additionally, generate a few unique plots highlighting some information from the dataset. Are there any interesting observations?

## Plot1

We now have a clear understanding of the customer proportion of total revenues in 2016 and 2017. New customers generate more revenue than existing customers.
```{r}
# New customer in 2016
orders_2016 %>%
  anti_join(orders_2015, by = "customer_email") %>%
  mutate(status = "New") -> nw2016

# New customer in 2017
orders_2017 %>%
  anti_join(orders_2016, by = "customer_email") %>%
  mutate(status = "New") -> nw2017

# Existing customer in 2016
orders_2016 %>%
  semi_join(orders_2015, by = "customer_email") %>%
  mutate(status = "Existing") -> ex2016

# Existing customer in 2017
orders_2017 %>%
  semi_join(orders_2016, by = "customer_email") %>%
  mutate(status = "Existing") -> ex2017

nw2016 %>%
  bind_rows(nw2017) %>%
  bind_rows(ex2016) %>%
  bind_rows(ex2017) -> en_20162017
en_20162017 %>%
  group_by(year, status) %>%
  summarise(revenue = sum(net_revenue)) %>%
  ggplot(aes(x = as.factor(year), y = revenue, fill = status)) +
   geom_bar(stat = "identity",
           position = "stack") +
  ggtitle("Revenue from existing/New customers") +
  theme_bw()
```

## Plot 2
According to data from 2016 and 2017, the number of new customers is always greater than the number of existing customers. The customer should begin to consider ways to increase customer engagement.
```{r}
en_20162017 %>%
  group_by(year, status) %>%
  summarise(total_customer = n()) %>%
  ggplot(aes(x = as.factor(year), y = total_customer, fill = status)) +
   geom_bar(stat = "identity",
           position = "dodge") +
  ggtitle("Number of Customers") 
```

## Plot 3
```{r}

```



